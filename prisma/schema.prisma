// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String    @id @default(cuid())
  name          String
  email         String    @unique
  password      String
  image         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  ownedBoards   Board[]        @relation("BoardOwner")
  memberBoards  BoardMember[]
  assignedTasks Task[]         @relation("AssignedTasks")
  clients       Client[]
  workers       Worker[]
  aiSolutions   AISolution[]
  orders        Order[]
  libraryItems  Library[]
  workSessions  WorkSession[]
  bitacoraBoards BitacoraBoard[]
  companyExpenses CompanyExpense[]

  @@map("User")
}

model Client {
  id          String   @id @default(cuid())
  name        String
  description String?
  icon        String?
  logoUrl     String?
  phase       String   @default("PLANIFICACIÓN") // PLANIFICACIÓN, DESARROLLO, PRUEBAS, DESPLIEGUE, COMPLETADO
  totalAmount Float
  paidAmount  Float    @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  userId      String

  user      User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  timelines ClientTimeline[]

  @@map("Client")
}

model ClientTimeline {
  id          String   @id @default(cuid())
  title       String
  description String?
  type        String   @default("UPDATE") // UPDATE, PAYMENT, MILESTONE
  amount      Float?
  createdAt   DateTime @default(now())
  clientId    String

  client Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@map("ClientTimeline")
}

model CompanyExpense {
  id          String   @id @default(cuid())
  amount      Float
  category    String   // Software, Infraestructura, Marketing, Nómina, etc.
  description String?
  createdAt   DateTime @default(now())
  createdById String

  createdBy User @relation(fields: [createdById], references: [id], onDelete: Cascade)

  @@map("CompanyExpense")
}

model Board {
  id          String   @id @default(cuid())
  title       String
  description String?
  image       String?
  order       Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  ownerId     String

  owner        User          @relation("BoardOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  members      BoardMember[]
  lists        List[]
  workSessions WorkSession[]
  bitacoraBoards BitacoraBoard[]

  @@map("Board")
}

model BoardMember {
  id      String @id @default(cuid())
  boardId String
  userId  String

  board Board @relation(fields: [boardId], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([boardId, userId])
  @@map("_BoardMembers")
}

model List {
  id        String   @id @default(cuid())
  title     String
  order     Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  boardId   String

  board        Board         @relation(fields: [boardId], references: [id], onDelete: Cascade)
  tasks        Task[]
  workSessions WorkSession[]

  @@map("List")
}

model Task {
  id          String    @id @default(cuid())
  title       String
  description String?
  dueDate     DateTime?
  image       String?
  status      String    @default("pending")
  order       Int
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  listId      String
  assignedTo  String?

  list     List      @relation(fields: [listId], references: [id], onDelete: Cascade)
  assigned User?     @relation("AssignedTasks", fields: [assignedTo], references: [id])
  tags     TaskTag[]

  @@map("Task")
}

model Tag {
  id        String   @id @default(cuid())
  name      String   @unique
  color     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tasks TaskTag[]

  @@map("Tag")
}

model TaskTag {
  id     String @id @default(cuid())
  taskId String
  tagId  String

  task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)
  tag  Tag  @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@unique([taskId, tagId])
  @@map("_TaskTags")
}

model Worker {
  id                String       @id @default(cuid())
  name              String
  type              String       // "HUMAN" o "AI"
  responsibilities  String
  status            String       // "FOUNDER", "EARLY_EMPLOYEE", "EMPLOYEE", "CONTRACTOR", etc.
  salary            Float        @default(0)
  paymentType       String       @default("FIXED") // "FIXED", "PERCENTAGE", "HYBRID"
  percentage        Float?       // Si es por porcentaje
  startDate         DateTime     @default(now())
  paymentDate       Int?         // Día del mes (1-31)
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt
  userId            String

  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  paymentLogs PaymentLog[]

  @@map("Worker")
}

model PaymentLog {
  id          String   @id @default(cuid())
  type        String   // "PAYMENT", "SALARY_INCREASE", "BONUS", "ADJUSTMENT"
  amount      Float
  previousSalary Float? // Salario anterior (para aumentos)
  newSalary   Float?   // Nuevo salario (para aumentos)
  description String?
  paymentDate DateTime @default(now())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  workerId    String

  worker Worker @relation(fields: [workerId], references: [id], onDelete: Cascade)

  @@map("PaymentLog")
}

model AISolution {
  id            String   @id @default(cuid())
  name          String
  description   String?
  category      String   // Nombre de la categoría personalizada
  categoryColor String?  // Color de la categoría (ej: "bg-blue-500")
  type          String   @default("INDIVIDUAL") // "INDIVIDUAL" o "BUNDLE"
  price         Float?
  features      String?  // JSON string con características
  icon          String?
  order         Int      @default(0) // Orden para drag and drop
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  userId        String

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  bundleItems BundleItem[] @relation("BundleSolutions")
  bundles     BundleItem[] @relation("SolutionInBundles")
  orderItems  OrderItem[]

  @@map("AISolution")
}

model BundleItem {
  id         String @id @default(cuid())
  bundleId   String
  solutionId String

  bundle   AISolution @relation("BundleSolutions", fields: [bundleId], references: [id], onDelete: Cascade)
  solution AISolution @relation("SolutionInBundles", fields: [solutionId], references: [id], onDelete: Cascade)

  @@unique([bundleId, solutionId])
  @@map("_BundleItems")
}

model Order {
  id          String      @id @default(cuid())
  orderNumber String      @unique // Número de pedido único
  status      String      @default("PENDING") // PENDING, CONFIRMED, PROCESSING, COMPLETED, CANCELLED
  totalAmount Float
  notes       String?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  userId      String

  user  User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  items OrderItem[]

  @@map("Order")
}

model OrderItem {
  id          String   @id @default(cuid())
  quantity    Int      @default(1)
  unitPrice   Float
  totalPrice  Float
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  orderId     String
  solutionId  String

  order    Order       @relation(fields: [orderId], references: [id], onDelete: Cascade)
  solution AISolution  @relation(fields: [solutionId], references: [id], onDelete: Cascade)

  @@map("OrderItem")
}

model Library {
  id          String   @id @default(cuid())
  title       String
  description String?
  url         String
  type        String   // "VIDEO", "PDF", "LINK", "DOCUMENT"
  category    String?  // Categoría personalizada (ej: "Tutoriales", "Documentación", "Recursos")
  thumbnail   String?  // URL de thumbnail para videos
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  userId      String

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("Library")
}

model WorkSession {
  id              String   @id @default(cuid())
  userId          String
  boardId         String?
  bitacoraBoardId String?
  listId          String?
  date            DateTime // Fecha del trabajo
  startTime       String   // Formato HH:mm
  endTime         String   // Formato HH:mm
  durationMinutes Int      // Calculado automáticamente
  tasksCompleted  Int      @default(0)
  description     String?  // Texto libre: qué hizo
  workType        String   @default("dev") // dev, diseño, ops, calls, etc
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  board        Board?        @relation(fields: [boardId], references: [id], onDelete: Cascade)
  bitacoraBoard BitacoraBoard? @relation(fields: [bitacoraBoardId], references: [id], onDelete: Cascade)
  list         List?         @relation(fields: [listId], references: [id], onDelete: SetNull)

  @@map("WorkSession")
}

model BitacoraBoard {
  id          String   @id @default(cuid())
  title       String
  description String?
  image       String?
  order       Int      @default(0)
  boardId     String?  // Roadmap asociado (opcional)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  userId      String   // El dueño de la bitácora

  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  board        Board?        @relation(fields: [boardId], references: [id], onDelete: SetNull)
  workSessions WorkSession[]
  avatar       BitacoraAvatar?

  @@map("BitacoraBoard")
}

model BitacoraAvatar {
  id              String   @id @default(cuid())
  bitacoraBoardId String   @unique
  level           Int      @default(1)
  experience      Int      @default(0) // XP total acumulado
  totalHours      Float    @default(0) // Horas totales trabajadas
  totalTasks      Int      @default(0) // Tareas completadas
  totalSessions   Int      @default(0) // Sesiones registradas
  avatarStyle     String   @default("basic") // Estilo del avatar según nivel
  rank            String   @default("Principiante") // Nivel: Principiante, Intermedio, Avanzado, Épico, Leyenda
  avatarImageUrl String?  // URL de la imagen del emblema del rango
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  bitacoraBoard BitacoraBoard @relation(fields: [bitacoraBoardId], references: [id], onDelete: Cascade)

  @@map("BitacoraAvatar")
}



